<?xml version="1.0"?>
<!--
/************************************************************************
 * To the extent possible under law, Nils Maier has waived all copyright
 * and related or neighboring rights to this work.
 ************************************************************************/
-->
<overlay xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul">
  <script type="text/javascript"><![CDATA[
    (function(self) {
      "use strict";
      try {
        if (!('@downthemall.net/async-file-output-stream;1' in Cc)) {
          throw Error("asyncfileoutputstream not registered!");
        }
        if (!('openStream' in self.Chunk.prototype)) {
          throw Error("dta incompatible!");
        }
        const AsyncFileOutputStream = Construct('@downthemall.net/async-file-output-stream;1', 'dtaIAsyncFileOutputStream', 'initPreallocated');
        self.Chunk.prototype.openStream = function(file, at) {
          let outStream = new AsyncFileOutputStream(file, 0x02 | 0x08, Prefs.permissions, this.parent.totalSize);
          let seekable = outStream.QueryInterface(Ci.nsISeekableStream);
          seekable.seek(0x00, at);
          if (this.remaining > 0) {
            outStream = new BufferedOutputStream(outStream, Math.min(this.remaining, MIN_CHUNK_SIZE * 2));
          }
          else {
            outStream = new BufferedOutputStream(outStream, MIN_CHUNK_SIZE * 2);
          }
          return outStream;
        }
        self.QueueItem.prototype.prealloc = function() false;
      }
      catch (ex) {
        Components.utils.reportError(ex);
      }
    })(this);
  ]]></script>
</overlay>
